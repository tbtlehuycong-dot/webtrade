<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeLog AI - Nhật ký giao dịch thông minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .active-nav { background-color: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.2); }
        .glass-modal { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="overflow-hidden">
    <div id="app" class="flex h-screen overflow-hidden flex-col md:flex-row">
        <!-- Loading State -->
        <div id="loading-screen" class="fixed inset-0 z-[200] flex items-center justify-center bg-white">
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 font-bold text-slate-500">Đang khởi tạo hệ thống...</p>
            </div>
        </div>

        <!-- Auth Screen -->
        <div id="auth-screen" class="hidden fixed inset-0 z-[150] bg-slate-50 flex items-center justify-center p-4">
            <div class="bg-white max-w-md w-full p-10 rounded-[2.5rem] shadow-2xl border text-center space-y-8">
                <div class="w-24 h-24 bg-blue-600 rounded-[2rem] flex items-center justify-center mx-auto rotate-6 shadow-xl">
                    <i data-lucide="trending-up" class="text-white w-12 h-12 -rotate-6"></i>
                </div>
                <div class="space-y-2">
                    <h1 class="text-3xl font-black text-slate-900">TradeLog AI</h1>
                    <p class="text-slate-500 font-medium">Nhật ký giao dịch kỷ luật hơn với AI</p>
                </div>
                <button id="login-btn" class="w-full flex items-center justify-center gap-3 bg-slate-900 text-white p-5 rounded-2xl font-bold hover:bg-slate-800 transition-all transform active:scale-95 shadow-lg">
                    <i data-lucide="log-in" size="20"></i> Bắt đầu ngay (Ẩn danh)
                </button>
                <p class="text-[10px] text-slate-400 uppercase font-black tracking-widest">Dữ liệu được lưu trữ an toàn trên Cloud</p>
            </div>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t md:relative md:border-t-0 md:border-r md:w-72 md:h-screen flex md:flex-col z-50 shadow-sm">
            <div class="hidden md:flex items-center p-8 border-b">
                <div class="p-2 bg-blue-600 rounded-xl mr-3 shadow-lg shadow-blue-100">
                    <i data-lucide="trending-up" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-black text-slate-800 tracking-tight">TradeLog <span class="text-blue-600">AI</span></h1>
            </div>
            
            <div class="flex md:flex-col flex-1 p-3 md:p-5 space-y-0 md:space-y-2">
                <button onclick="switchTab('dashboard')" class="nav-item flex items-center justify-center md:justify-start p-4 rounded-2xl transition-all flex-1 md:flex-none active-nav" id="nav-dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="hidden md:inline ml-4 font-bold text-sm">Dashboard</span>
                </button>
                <button onclick="switchTab('add')" class="nav-item flex items-center justify-center md:justify-start p-4 rounded-2xl transition-all flex-1 md:flex-none text-slate-400" id="nav-add">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span class="hidden md:inline ml-4 font-bold text-sm">Vào lệnh mới</span>
                </button>
                <button onclick="switchTab('history')" class="nav-item flex items-center justify-center md:justify-start p-4 rounded-2xl transition-all flex-1 md:flex-none text-slate-400" id="nav-history">
                    <i data-lucide="history" class="w-5 h-5"></i>
                    <span class="hidden md:inline ml-4 font-bold text-sm">Lịch sử Trade</span>
                </button>
            </div>

            <div class="hidden md:block p-6 border-t mt-auto">
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-2xl border mb-3">
                    <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600"><i data-lucide="user" size="18"></i></div>
                    <div class="truncate flex-1">
                        <p id="user-name" class="font-bold text-xs truncate text-slate-700">Trader</p>
                        <p class="text-[9px] text-slate-400 font-black uppercase">Standard Plan</p>
                    </div>
                </div>
                <button id="logout-btn" class="flex items-center justify-center gap-2 text-red-500 p-3 rounded-xl text-xs font-bold hover:bg-red-50 w-full transition-all border border-transparent hover:border-red-100">
                    <i data-lucide="log-out" size="14"></i> Đăng xuất
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden h-full flex flex-col">
            <!-- Scrollable Area -->
            <div id="content-area" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-10 pb-24 md:pb-10 h-full">
                
                <!-- Tab Dashboard -->
                <div id="tab-dashboard" class="tab-content max-w-6xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">Dashboard</h2>
                            <p class="text-slate-500 font-medium">Chào mừng trở lại, hôm nay kế hoạch của bạn là gì?</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="toggleBalanceEdit()" class="bg-white border p-3.5 rounded-2xl text-xs font-bold flex items-center gap-2 shadow-sm hover:bg-slate-50 transition-all"><i data-lucide="settings-2" size="16"></i> Quản lý vốn</button>
                            <button onclick="analyzeAI()" class="bg-blue-600 text-white p-3.5 px-6 rounded-2xl text-xs font-bold flex items-center gap-2 shadow-xl shadow-blue-200 hover:bg-blue-700 transition-all"><i data-lucide="sparkles" size="16"></i> Phân tích AI</button>
                        </div>
                    </div>

                    <!-- Balance Update Form -->
                    <div id="balance-form" class="hidden bg-blue-50 border border-blue-100 p-8 rounded-[2rem] flex flex-col md:flex-row gap-4 items-end animate-in slide-in-from-top-4 duration-300">
                        <div class="flex-1 w-full">
                            <label class="text-[10px] font-black text-blue-500 uppercase mb-2 block tracking-widest">Số dư khởi điểm ($)</label>
                            <input id="initial-balance-input" type="number" class="w-full p-4 rounded-2xl border-none shadow-inner font-black text-lg focus:ring-2 ring-blue-300 outline-none" value="1000">
                        </div>
                        <button onclick="saveBalance()" class="w-full md:w-auto bg-blue-600 text-white px-10 py-4 rounded-2xl text-sm font-black shadow-lg">Cập nhật số dư</button>
                    </div>

                    <!-- PnL Metrics -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-6 rounded-[2rem] border shadow-sm border-b-4 border-b-blue-500">
                            <div class="p-3 bg-blue-50 text-blue-600 rounded-xl w-fit mb-4"><i data-lucide="wallet"></i></div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Số dư hiện tại</p>
                            <p id="stat-balance" class="text-2xl font-black mt-1">$0.00</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] border shadow-sm border-b-4" id="card-daily">
                            <div class="p-3 bg-slate-50 text-slate-600 rounded-xl w-fit mb-4"><i data-lucide="clock"></i></div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">PnL Hôm nay</p>
                            <p id="stat-daily" class="text-2xl font-black mt-1">$0.00</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] border shadow-sm border-b-4" id="card-weekly">
                            <div class="p-3 bg-slate-50 text-slate-600 rounded-xl w-fit mb-4"><i data-lucide="calendar-days"></i></div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">PnL Tuần này</p>
                            <p id="stat-weekly" class="text-2xl font-black mt-1">$0.00</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] border shadow-sm border-b-4" id="card-monthly">
                            <div class="p-3 bg-slate-50 text-slate-600 rounded-xl w-fit mb-4"><i data-lucide="trending-up"></i></div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">PnL Tháng này</p>
                            <p id="stat-monthly" class="text-2xl font-black mt-1">$0.00</p>
                        </div>
                    </div>

                    <!-- Main Dashboard Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-8 rounded-[2.5rem] border shadow-sm space-y-6">
                            <h3 class="text-xl font-black text-slate-800 flex items-center gap-3">
                                <i data-lucide="activity" class="text-blue-600"></i> Lệnh gần đây
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="text-slate-400 border-b border-slate-100">
                                        <tr>
                                            <th class="pb-4 text-left font-black uppercase text-[9px] tracking-widest">Tài sản</th>
                                            <th class="pb-4 text-center font-black uppercase text-[9px] tracking-widest">Loại</th>
                                            <th class="pb-4 text-center font-black uppercase text-[9px] tracking-widest">Kết quả</th>
                                            <th class="pb-4 text-right font-black uppercase text-[9px] tracking-widest">PnL ($)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-trades-body" class="divide-y divide-slate-50">
                                        <!-- Trades injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm flex flex-col items-center text-center justify-center space-y-4">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tỉ lệ thắng (Win Rate)</p>
                            <div class="relative w-40 h-40 flex items-center justify-center">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent" class="text-slate-100" />
                                    <circle id="winrate-circle" cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent" 
                                        stroke-dasharray="439.8" stroke-dashoffset="439.8"
                                        class="text-blue-600 transition-all duration-1000 ease-out" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span id="stat-winrate" class="text-3xl font-black">0%</span>
                                </div>
                            </div>
                            <div class="pt-4 border-t w-full">
                                <p id="stat-count" class="text-sm font-bold text-slate-500">0 thắng / 0 chốt</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Add Trade -->
                <div id="tab-add" class="tab-content hidden max-w-2xl mx-auto space-y-8 animate-in slide-in-from-bottom-4 duration-500">
                    <div class="text-center space-y-2">
                        <h2 class="text-3xl font-black text-slate-900">MỞ LỆNH MỚI</h2>
                        <p class="text-slate-500 font-medium">Ghi lại kế hoạch trước khi bắt đầu để kỷ luật hơn.</p>
                    </div>

                    <form id="trade-form" class="bg-white p-10 rounded-[3rem] border shadow-2xl space-y-10">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Cặp tiền</label>
                                <input id="symbol" required placeholder="BTC/USDT" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black outline-none focus:ring-2 ring-blue-100 transition-all">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Vị thế</label>
                                <select id="type" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black outline-none cursor-pointer">
                                    <option value="LONG">LONG</option>
                                    <option value="SHORT">SHORT</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Đòn bẩy</label>
                                <input id="leverage" type="number" value="1" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black font-mono outline-none">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Vào giá</label>
                                <input id="entry" required type="number" step="any" placeholder="0.00" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black font-mono outline-none">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Cắt lỗ</label>
                                <input id="sl" required type="number" step="any" placeholder="0.00" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black font-mono outline-none">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Chốt lời</label>
                                <input id="tp" required type="number" step="any" placeholder="0.00" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black font-mono outline-none">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Số vốn $</label>
                                <input id="size" required type="number" step="any" placeholder="100" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black font-mono outline-none">
                            </div>
                        </div>

                        <div class="p-8 bg-blue-50/50 rounded-[2rem] border border-blue-100 space-y-6">
                            <label class="text-xs font-black text-blue-600 flex items-center gap-2"><i data-lucide="smile" size="16"></i> TÂM LÝ KHI VÀO LỆNH</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button type="button" onclick="setMindset('Calm')" class="mindset-btn p-4 rounded-2xl text-[10px] font-black transition-all bg-white border-2 border-blue-600 text-blue-600 shadow-md" id="ms-Calm">Bình tĩnh</button>
                                <button type="button" onclick="setMindset('Anxious')" class="mindset-btn p-4 rounded-2xl text-[10px] font-black transition-all bg-white/50 border-2 border-transparent text-slate-400" id="ms-Anxious">Lo lắng</button>
                                <button type="button" onclick="setMindset('Euphoric')" class="mindset-btn p-4 rounded-2xl text-[10px] font-black transition-all bg-white/50 border-2 border-transparent text-slate-400" id="ms-Euphoric">Phấn khích</button>
                                <button type="button" onclick="setMindset('Revenge')" class="mindset-btn p-4 rounded-2xl text-[10px] font-black transition-all bg-white/50 border-2 border-transparent text-slate-400" id="ms-Revenge">Trả thù</button>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="message-square" size="14"></i> Lý do vào lệnh</label>
                                <textarea id="entryReason" rows="3" placeholder="Phân tích của bạn là gì? Tại sao chọn vị thế này?" class="w-full p-5 bg-slate-50 rounded-2xl border-none text-sm font-medium outline-none focus:ring-2 ring-blue-100"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 text-white p-6 rounded-[2rem] font-black text-xl shadow-2xl shadow-blue-200 hover:bg-blue-700 transition-all transform active:scale-[0.98]">XÁC NHẬN VÀO LỆNH</button>
                    </form>
                </div>

                <!-- Tab History -->
                <div id="tab-history" class="tab-content hidden max-w-4xl mx-auto space-y-6 animate-in fade-in duration-500">
                    <h2 class="text-3xl font-black text-slate-900 mb-8">LỊCH SỬ CHI TIẾT</h2>
                    <div id="history-container" class="space-y-6 pb-20">
                        <!-- Trade cards injected here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <div id="ai-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
            <div class="bg-white w-full max-w-xl rounded-[2.5rem] overflow-hidden shadow-2xl animate-in zoom-in-95 duration-200">
                <div class="bg-blue-600 p-8 text-white">
                    <h3 class="text-2xl font-black flex items-center gap-2"><i data-lucide="sparkles"></i> AI PHẢN HỒI</h3>
                </div>
                <div id="ai-content" class="p-8 max-h-[50vh] overflow-y-auto font-medium text-slate-700 whitespace-pre-wrap leading-relaxed">
                    <!-- AI text -->
                </div>
                <div class="p-6 border-t bg-slate-50 text-right">
                    <button onclick="closeModal('ai-modal')" class="bg-slate-900 text-white px-8 py-4 rounded-2xl font-black">XÁC NHẬN</button>
                </div>
            </div>
        </div>

        <!-- Close Trade Modal -->
        <div id="close-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md">
            <div class="bg-white w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl p-10 space-y-8">
                <h3 class="text-2xl font-black text-slate-900">CHỐT LỆNH</h3>
                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Giá thoát lệnh</label>
                        <input id="close-price" type="number" step="any" placeholder="0.00" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black text-xl outline-none focus:ring-2 ring-blue-100">
                    </div>
                    <div class="space-y-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Bạn có thay đổi SL/TP trong khi chạy?</label>
                        <div class="flex gap-2">
                            <button id="mod-no" onclick="setWasModified('No')" class="flex-1 p-4 rounded-2xl text-xs font-black transition-all border-2 border-blue-600 bg-blue-50 text-blue-600">Không</button>
                            <button id="mod-yes" onclick="setWasModified('Yes')" class="flex-1 p-4 rounded-2xl text-xs font-black transition-all border-2 border-transparent bg-slate-50 text-slate-400">Có thay đổi</button>
                        </div>
                    </div>
                    <div id="mod-reason-container" class="hidden space-y-2 animate-in slide-in-from-top-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tại sao bạn dời kế hoạch?</label>
                        <textarea id="mod-reason" placeholder="Ví dụ: FOMO, Sợ hãi, Thấy nến xấu..." class="w-full p-4 bg-slate-50 rounded-2xl border-none text-sm font-medium outline-none"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button id="confirm-close-btn" class="flex-1 bg-blue-600 text-white p-5 rounded-2xl font-black shadow-lg">XÁC NHẬN CHỐT</button>
                    <button onclick="closeModal('close-modal')" class="px-8 bg-slate-100 text-slate-500 p-5 rounded-2xl font-black">HỦY</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Initialization & State ---
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'trading-journal-v1';
        const apiKey = ""; // API Key for Gemini

        let currentUser = null;
        let trades = [];
        let initialBalance = 1000;
        let selectedMindset = 'Calm';
        let wasModified = 'No';
        let currentClosingTradeId = null;

        // --- Auth Logic ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (err) {
                console.error("Auth Error:", err);
            }
        }

        auth.onAuthStateChanged(user => {
            currentUser = user;
            document.getElementById('loading-screen').classList.add('hidden');
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('user-name').innerText = user.displayName || 'Trader';
                startListening();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            auth.signInAnonymously();
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut();
        });

        // --- Firestore Real-time ---
        function startListening() {
            const userId = currentUser.uid;
            
            // Listen to Settings
            db.doc(`artifacts/${appId}/users/${userId}/settings/account`).onSnapshot(doc => {
                if (doc.exists) {
                    initialBalance = doc.data().initialBalance || 1000;
                    document.getElementById('initial-balance-input').value = initialBalance;
                    calculateStats();
                }
            });

            // Listen to Trades
            db.collection(`artifacts/${appId}/users/${userId}/trades`).onSnapshot(snapshot => {
                trades = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() || new Date()
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                calculateStats();
                renderTrades();
                renderHistory();
            });
        }

        // --- UI Logic ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active-nav');
                el.classList.add('text-slate-400');
            });
            document.getElementById(`nav-${tab}`).classList.add('active-nav');
            document.getElementById(`nav-${tab}`).classList.remove('text-slate-400');
            
            lucide.createIcons();
        }

        function toggleBalanceEdit() {
            const form = document.getElementById('balance-form');
            form.classList.toggle('hidden');
        }

        async function saveBalance() {
            const val = parseFloat(document.getElementById('initial-balance-input').value);
            if (isNaN(val)) return;
            await db.doc(`artifacts/${appId}/users/${currentUser.uid}/settings/account`).set({ initialBalance: val }, { merge: true });
            toggleBalanceEdit();
        }

        function setMindset(m) {
            selectedMindset = m;
            document.querySelectorAll('.mindset-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600', 'shadow-md');
                btn.classList.add('border-transparent', 'text-slate-400');
            });
            document.getElementById(`ms-${m}`).classList.add('border-blue-600', 'text-blue-600', 'shadow-md');
            document.getElementById(`ms-${m}`).classList.remove('border-transparent', 'text-slate-400');
        }

        function setWasModified(val) {
            wasModified = val;
            const container = document.getElementById('mod-reason-container');
            const btnYes = document.getElementById('mod-yes');
            const btnNo = document.getElementById('mod-no');
            
            if (val === 'Yes') {
                container.classList.remove('hidden');
                btnYes.className = "flex-1 p-4 rounded-2xl text-xs font-black transition-all border-2 border-blue-600 bg-blue-50 text-blue-600";
                btnNo.className = "flex-1 p-4 rounded-2xl text-xs font-black transition-all border-2 border-transparent bg-slate-50 text-slate-400";
            } else {
                container.classList.add('hidden');
                btnNo.className = "flex-1 p-4 rounded-2xl text-xs font-black transition-all border-2 border-blue-600 bg-blue-50 text-blue-600";
                btnYes.className = "flex-1 p-4 rounded-2xl text-xs font-black transition-all border-2 border-transparent bg-slate-50 text-slate-400";
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- Core Stats & Rendering ---
        function calculateStats() {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const dayOfWeek = now.getDay();
            const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diffToMonday);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const closed = trades.filter(t => t.status !== 'OPEN');
            const wins = closed.filter(t => t.status === 'WIN');

            let totalPnl = 0, daily = 0, weekly = 0, monthly = 0;

            closed.forEach(t => {
                const pnl = (t.type === 'LONG' ? (t.exitPrice - t.entry) : (t.entry - t.exitPrice)) * t.size;
                totalPnl += pnl;
                if (t.timestamp >= startOfToday) daily += pnl;
                if (t.timestamp >= startOfWeek) weekly += pnl;
                if (t.timestamp >= startOfMonth) monthly += pnl;
            });

            const winrate = closed.length > 0 ? (wins.length / closed.length * 100).toFixed(1) : 0;
            
            // Update UI
            document.getElementById('stat-balance').innerText = `$${(initialBalance + totalPnl).toFixed(2)}`;
            document.getElementById('stat-daily').innerText = `${daily >= 0 ? '+' : ''}$${daily.toFixed(2)}`;
            document.getElementById('stat-weekly').innerText = `${weekly >= 0 ? '+' : ''}$${weekly.toFixed(2)}`;
            document.getElementById('stat-monthly').innerText = `${monthly >= 0 ? '+' : ''}$${monthly.toFixed(2)}`;
            document.getElementById('stat-winrate').innerText = `${winrate}%`;
            document.getElementById('stat-count').innerText = `${wins.length} thắng / ${closed.length} chốt`;

            // Update Colors
            updatePnlColor('card-daily', daily);
            updatePnlColor('card-weekly', weekly);
            updatePnlColor('card-monthly', monthly);

            // Update Circle
            const circle = document.getElementById('winrate-circle');
            const offset = 439.8 - (439.8 * winrate / 100);
            circle.style.strokeDashoffset = offset;
        }

        function updatePnlColor(id, val) {
            const el = document.getElementById(id);
            if (val > 0) el.className = "bg-white p-6 rounded-[2rem] border shadow-sm border-b-4 border-b-green-500 text-green-600";
            else if (val < 0) el.className = "bg-white p-6 rounded-[2rem] border shadow-sm border-b-4 border-b-red-500 text-red-600";
            else el.className = "bg-white p-6 rounded-[2rem] border shadow-sm border-b-4 border-b-slate-200 text-slate-600";
        }

        function renderTrades() {
            const body = document.getElementById('recent-trades-body');
            body.innerHTML = trades.slice(0, 5).map(t => {
                const pnl = t.status === 'OPEN' ? 0 : (t.type === 'LONG' ? (t.exitPrice - t.entry) : (t.entry - t.exitPrice)) * t.size;
                return `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="py-5 font-black text-slate-700">${t.symbol}</td>
                        <td class="py-5 text-center font-black ${t.type === 'LONG' ? 'text-green-600' : 'text-red-600'}">${t.type}</td>
                        <td class="py-5 text-center">${getStatusBadge(t.status)}</td>
                        <td class="py-5 text-right font-black ${pnl > 0 ? 'text-green-600' : pnl < 0 ? 'text-red-600' : 'text-slate-400'}">${t.status === 'OPEN' ? '--' : pnl.toFixed(1)}</td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            const styles = { 
                OPEN: "bg-blue-100 text-blue-600 border-blue-200", 
                WIN: "bg-green-100 text-green-600 border-green-200", 
                LOSS: "bg-red-100 text-red-600 border-red-200", 
                BREAK_EVEN: "bg-slate-100 text-slate-600 border-slate-200" 
            };
            return `<span class="text-[9px] font-black p-1.5 px-3 rounded-lg border tracking-widest ${styles[status]}">${status}</span>`;
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = trades.map(t => {
                const pnl = t.status === 'OPEN' ? 0 : (t.type === 'LONG' ? (t.exitPrice - t.entry) : (t.entry - t.exitPrice)) * t.size;
                const mindsetLabels = { Calm: 'Bình tĩnh', Anxious: 'Lo lắng', Euphoric: 'Phấn khích', Revenge: 'Trả thù' };
                return `
                    <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm space-y-6">
                        <div class="flex justify-between items-start flex-wrap gap-4">
                            <div class="flex items-center gap-4">
                                <div class="p-4 rounded-2xl ${t.type === 'LONG' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                                    <i data-lucide="${t.type === 'LONG' ? 'trending-up' : 'trending-down'}" size="24"></i>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <p class="font-black text-xl text-slate-800">${t.symbol}</p>
                                        <span class="text-[10px] font-black bg-slate-900 text-white px-2 py-1 rounded">x${t.leverage}</span>
                                    </div>
                                    <p class="text-[9px] text-slate-400 font-black uppercase tracking-widest">${t.timestamp.toLocaleString('vi-VN')}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${getStatusBadge(t.status)}
                                <button onclick="analyzeAI('${t.id}')" class="p-3 bg-slate-50 rounded-xl text-purple-600 hover:bg-purple-100 transition-colors"><i data-lucide="sparkles" size="16"></i></button>
                                ${t.status === 'OPEN' ? `<button onclick="openCloseModal('${t.id}')" class="px-6 py-3 bg-blue-600 text-white text-xs font-black rounded-xl shadow-lg shadow-blue-100 hover:bg-blue-700">CHỐT LỆNH</button>` : ''}
                                <button onclick="deleteTrade('${t.id}')" class="p-3 text-slate-200 hover:text-red-500 transition-colors"><i data-lucide="trash-2" size="16"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-dashed">
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Entry / Size</p>
                                <p class="text-xs font-black font-mono text-slate-700">${t.entry} / ${t.size}$</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-dashed">
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Tâm lý đầu</p>
                                <p class="text-xs font-black text-slate-700">${mindsetLabels[t.preMindset] || 'Bình tĩnh'}</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-dashed">
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Dời SL/TP?</p>
                                <p class="text-xs font-black ${t.wasModified === 'Yes' ? 'text-orange-500' : 'text-slate-700'}">${t.wasModified === 'Yes' ? 'Có thay đổi' : 'Kỷ luật'}</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-dashed">
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">PnL</p>
                                <p class="text-xs font-black ${pnl > 0 ? 'text-green-600' : pnl < 0 ? 'text-red-600' : 'text-slate-400'}">${t.status === 'OPEN' ? '--' : pnl.toFixed(2) + '$'}</p>
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border-l-4 border-l-blue-400">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Lý do vào lệnh:</p>
                            <p class="text-xs font-medium text-slate-600 italic leading-relaxed">${t.entryReason || "Không có ghi chú."}</p>
                        </div>
                        ${t.wasModified === 'Yes' ? `
                            <div class="p-4 bg-orange-50 border border-orange-100 rounded-2xl flex items-start gap-3">
                                <i data-lucide="alert-circle" class="text-orange-500 w-4 h-4 mt-0.5"></i>
                                <p class="text-xs text-orange-700 font-medium italic">"Lý do dời SL/TP: ${t.modificationReason}"</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- Event Handlers ---
        document.getElementById('trade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                symbol: document.getElementById('symbol').value.toUpperCase(),
                type: document.getElementById('type').value,
                leverage: parseInt(document.getElementById('leverage').value),
                entry: parseFloat(document.getElementById('entry').value),
                sl: parseFloat(document.getElementById('sl').value),
                tp: parseFloat(document.getElementById('tp').value),
                size: parseFloat(document.getElementById('size').value),
                preMindset: selectedMindset,
                entryReason: document.getElementById('entryReason').value,
                status: 'OPEN',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection(`artifacts/${appId}/users/${currentUser.uid}/trades`).add(data);
            e.target.reset();
            setMindset('Calm');
            switchTab('history');
        });

        async function deleteTrade(id) {
            if (confirm('Bạn có chắc chắn muốn xóa lệnh này không?')) {
                await db.doc(`artifacts/${appId}/users/${currentUser.uid}/trades/${id}`).delete();
            }
        }

        function openCloseModal(id) {
            currentClosingTradeId = id;
            document.getElementById('close-modal').classList.remove('hidden');
            document.getElementById('close-price').focus();
        }

        document.getElementById('confirm-close-btn').addEventListener('click', async () => {
            const exitPrice = parseFloat(document.getElementById('close-price').value);
            const modReason = document.getElementById('mod-reason').value;
            if (isNaN(exitPrice)) return;

            const trade = trades.find(t => t.id === currentClosingTradeId);
            let status = 'BREAK_EVEN';
            const profit = trade.type === 'LONG' ? (exitPrice - trade.entry) : (trade.entry - exitPrice);
            if (profit > 0.0001) status = 'WIN';
            else if (profit < -0.0001) status = 'LOSS';

            await db.doc(`artifacts/${appId}/users/${currentUser.uid}/trades/${currentClosingTradeId}`).update({
                exitPrice,
                status,
                wasModified,
                modificationReason: modReason
            });

            closeModal('close-modal');
            document.getElementById('close-price').value = '';
            document.getElementById('mod-reason').value = '';
            setWasModified('No');
        });

        // --- AI Logic ---
        async function analyzeAI(tradeId = null) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-content');
            
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="flex flex-col items-center p-10"><div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div><p class="mt-4 font-bold">AI đang phân tích dữ liệu giao dịch...</p></div>';

            const systemPrompt = "Bạn là chuyên gia phân tích tâm lý và kỹ thuật giao dịch chuyên nghiệp (Trading Mentor). Hãy nhận xét cực kỳ chân thực, đôi khi khắt khe để giúp trader kỷ luật hơn. Trả lời bằng tiếng Việt.";
            let userPrompt = "";

            if (tradeId) {
                const t = trades.find(tr => tr.id === tradeId);
                userPrompt = `Nhận xét lệnh ${t.symbol} (${t.type}). Trạng thái: ${t.status}. Tâm lý ban đầu: ${t.preMindset}. Kỷ luật: ${t.wasModified === 'Yes' ? 'Vi phạm (Dời SL/TP)' : 'Tốt'}. Lý do vào lệnh: ${t.entryReason}.`;
            } else {
                const closed = trades.filter(t => t.status !== 'OPEN');
                const winrate = closed.length > 0 ? (closed.filter(t => t.status === 'WIN').length / closed.length * 100).toFixed(1) : 0;
                userPrompt = `Tổng hợp tài khoản: ${closed.length} lệnh chốt, tỉ lệ thắng ${winrate}%. Hãy đưa ra lời khuyên về kỷ luật và quản lý vốn.`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const result = await response.json();
                content.innerText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Không có phản hồi từ AI.";
            } catch (err) {
                content.innerText = "Lỗi kết nối AI. Vui lòng kiểm tra lại cấu hình API.";
            }
        }

        // Initialize
        initAuth();
        lucide.createIcons();
    </script>
</body>
</html>